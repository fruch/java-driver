


<!doctype html>
<html class="no-js" lang="en">
  
<head><!-- begin head.html -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>
    Custom Codecs | Scylla Docs
    </title>
    <meta name="description" content="Scylla is an Apache Cassandra-compatible NoSQL data store that can handle 1 million transactions per second on a single server." />

    <link rel="icon" href="../../_static/img/favicon.ico" type="image/x-icon"/>
    <link rel="canonical" href="https://docs.scylladb.com/">

    <link rel="author" href="mailto:info@scylladb.com">
    <link rel="stylesheet" href="../../_static/" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx_tabs/semantic-ui-2.4.1/segment.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx_tabs/semantic-ui-2.4.1/menu.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx_tabs/tabs.css" />
    
    <link href='https://fonts.googleapis.com/css?family=Roboto:400,100,300,500,700' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.5.2/css/foundation.min.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/doc/main.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>

    <script src="../../_static/js/vendor/modernizr.js"></script>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-T8P2JP');</script>
    <!-- End Google Tag Manager -->

    <!-- Marketo -->
    <script type="text/javascript"> (function() { var didInit = false; function initMunchkin() { if(didInit === false) { didInit = true; Munchkin.init('791-QBF-350'); } } var s = document.createElement('script'); s.type = 'text/javascript'; s.async = true; s.src = '//munchkin.marketo.net/munchkin.js'; s.onreadystatechange = function() { if (this.readyState == 'complete' || this.readyState == 'loaded') { initMunchkin(); } }; s.onload = initMunchkin; document.getElementsByTagName('head')[0].appendChild(s); })(); </script>
    <!-- End Marketo -->

<!-- end head.html -->
</head>

<body>
<header id="header" class="animated">
    <div class="topbar_continer contain-to-grid clearfix">
        <nav class="top-bar" id="top-bar" data-topbar role="navigation">
            <ul class="title-area">
                <li class="name">
                    <div class="logo">
                        <a href="https://docs.scylladb.com/"><img src="../../_static/img/logo-scylla-docs.svg" alt="" width="151"></a>
                    </div>
                </li>
                <li class="toggle-topbar"><a href="#"><span class="icon-manu"></span></a></li>
            </ul>
            <section class="top-bar-section clearfix">
                <ul class="right">
                    
                    <li>
                        <a href="https://scylladb.github.io/java-driver/">Scylla Java Driver</a>
                    </li>
                    
                    <li>
                        <a href="https://docs.scylladb.com/scylla-cloud/">Scylla Cloud</a>
                    </li>
                    
                    <li>
                        <a href="https://university.scylladb.com/">Scylla University</a>
                    </li>
                    
                    <li>
                        <a href="https://www.scylladb.com/">ScyllaDB Home</a>
                    </li>
                    
                    <li class="search_continer show-for-medium-up">	
                        <ci-search></ci-search>	
                    </li>	
                </ul>
            </section>
        </nav>
    </div>
</header>
<section id="content">
    <div class="row">
	
	<div class="large-6 large-push-3 columns">
            <div class="section" id="custom-codecs">
<h1>Custom Codecs<a class="headerlink" href="#custom-codecs" title="Permalink to this headline">¶</a></h1>
<p>Custom codecs support transparent, user-configurable mapping of CQL types to arbitrary Java objects.</p>
<p>Practical use cases that justify such a feature are numerous:</p>
<ul class="simple">
<li><p>Ability to map CQL timestamp, date and time columns to Java 8 or Joda Time classes (rather than the built-in mappings for Date, <a class="reference external" href="https://docs.datastax.com/en/drivers/java/3.10/com/datastax/driver/core/LocalDate.html">LocalDate</a> and Long);</p></li>
<li><p>Ability to map CQL varchar columns directly to JSON or XML mapped objects (i.e. using frameworks such as Jackson);</p></li>
<li><p>Ability to map CQL user-defined types to Java objects;</p></li>
<li><p>Ability to map CQL lists directly to Java arrays;</p></li>
<li><p>Ability to map CQL collections directly to Scala collections;</p></li>
<li><p>etc.</p></li>
</ul>
<p>This page explains the implementation and how to write your own custom codecs. Note that the driver also provides a set
of <a class="reference external" href="extras/">optional codecs</a> that might fit your needs.</p>
<div class="section" id="overview-of-the-serialization-mechanism">
<h2>Overview of the serialization mechanism<a class="headerlink" href="#overview-of-the-serialization-mechanism" title="Permalink to this headline">¶</a></h2>
<p>The central piece in the serialization mechanism is <a class="reference external" href="https://docs.datastax.com/en/drivers/java/3.10/com/datastax/driver/core/TypeCodec.html">TypeCodec</a>.</p>
<p>Each <code class="docutils literal notranslate"><span class="pre">TypeCodec</span></code> supports a bidirectional mapping between a Java type and a CQL type. A <code class="docutils literal notranslate"><span class="pre">TypeCodec</span></code> is thus capable of 4 basic operations:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.datastax.com/en/drivers/java/3.10/com/datastax/driver/core/TypeCodec.html#serialize-T-com.datastax.driver.core.ProtocolVersion-">Serialize</a> a Java object into a CQL value;</p></li>
<li><p><a class="reference external" href="https://docs.datastax.com/en/drivers/java/3.10/com/datastax/driver/core/TypeCodec.html#deserialize-java.nio.ByteBuffer-com.datastax.driver.core.ProtocolVersion-">Deserialize</a> a CQL value into a Java object;</p></li>
<li><p><a class="reference external" href="https://docs.datastax.com/en/drivers/java/3.10/com/datastax/driver/core/TypeCodec.html#format-T-">Format</a> a Java object into a CQL literal;</p></li>
<li><p><a class="reference external" href="https://docs.datastax.com/en/drivers/java/3.10/com/datastax/driver/core/TypeCodec.html#parse-java.lang.String-">Parse</a> a CQL literal into a Java object.</p></li>
</ul>
<p>Additionally, it implements inspection methods that verify if the codec is suitable for a specific
CQL type and/or Java object.</p>
<p><code class="docutils literal notranslate"><span class="pre">TypeCodec</span></code> can be freely subclassed by users willing to implement their own serialization logic.
However, users are only required to do so when they want to extend
the driver’s default set of codecs by registering additional codecs that handle
Java types that the driver is otherwise unable to process. For all other users,
the built-in set of codecs that is bundled with the driver provides
exactly the same functionality that the driver used to offer so far,
with out-of-the-box conversion from all CQL types to standard Java equivalents.</p>
<p>Refer to the <a class="reference external" href="https://docs.datastax.com/en/drivers/java/3.10/com/datastax/driver/core/TypeCodec.html">javadocs</a> of <code class="docutils literal notranslate"><span class="pre">TypeCodec</span></code> for more information.</p>
<p><code class="docutils literal notranslate"><span class="pre">TypeCodec</span></code>s are centralized in a <a class="reference external" href="https://docs.datastax.com/en/drivers/java/3.10/com/datastax/driver/core/CodecRegistry.html">CodecRegistry</a> instance.
Whenever the driver needs to perform one of the aforementioned operations,
it will lookup for an appropriate codec in a <code class="docutils literal notranslate"><span class="pre">CodecRegistry</span></code>.
<code class="docutils literal notranslate"><span class="pre">CodecRegistry</span></code> is also used to manually register user-created codecs (see below for detailed instructions).
It also caches codec lookup results for faster execution whenever possible.</p>
<p>Refer to the <a class="reference external" href="https://docs.datastax.com/en/drivers/java/3.10/com/datastax/driver/core/CodecRegistry.html">javadocs</a> of <code class="docutils literal notranslate"><span class="pre">CodecRegistry</span></code> for more information.</p>
</div>
<div class="section" id="implementing-and-using-custom-codecs">
<h2>Implementing and using custom codecs<a class="headerlink" href="#implementing-and-using-custom-codecs" title="Permalink to this headline">¶</a></h2>
<p>Let’s consider the following scenario: a user has JSON documents stored in a varchar column, and wants
the driver to automatically map that column to a Java object using the <a class="reference external" href="https://github.com/FasterXML/jackson">Jackson</a> library,
instead of returning the raw JSON string.</p>
<p>The (admittedly simplistic) table structure is as follows:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">t</span> <span class="p">(</span><span class="n">id</span> <span class="nb">int</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span> <span class="n">json</span> <span class="nb">VARCHAR</span><span class="p">);</span>
</pre></div>
</div>
<p>The first step is to implement a suitable codec. Using Jackson, here is what a Json codec could look like:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * A simple Json codec.</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JsonCodec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">TypeCodec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">ObjectMapper</span> <span class="n">objectMapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectMapper</span><span class="o">();</span>

    <span class="kd">public</span> <span class="nf">JsonCodec</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">javaType</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">DataType</span><span class="o">.</span><span class="na">varchar</span><span class="o">(),</span> <span class="n">javaType</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">ByteBuffer</span> <span class="nf">serialize</span><span class="o">(</span><span class="n">T</span> <span class="n">value</span><span class="o">,</span> <span class="n">ProtocolVersion</span> <span class="n">protocolVersion</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InvalidTypeException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">objectMapper</span><span class="o">.</span><span class="na">writeValueAsBytes</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">JsonProcessingException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">InvalidTypeException</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&quot;unchecked&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">T</span> <span class="nf">deserialize</span><span class="o">(</span><span class="n">ByteBuffer</span> <span class="n">bytes</span><span class="o">,</span> <span class="n">ProtocolVersion</span> <span class="n">protocolVersion</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InvalidTypeException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">bytes</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">bytes</span><span class="o">.</span><span class="na">remaining</span><span class="o">()];</span>
            <span class="c1">// always duplicate the ByteBuffer instance before consuming it!</span>
            <span class="n">bytes</span><span class="o">.</span><span class="na">duplicate</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
            <span class="k">return</span> <span class="o">(</span><span class="n">T</span><span class="o">)</span> <span class="n">objectMapper</span><span class="o">.</span><span class="na">readValue</span><span class="o">(</span><span class="n">b</span><span class="o">,</span> <span class="n">toJacksonJavaType</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">InvalidTypeException</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">format</span><span class="o">(</span><span class="n">T</span> <span class="n">value</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InvalidTypeException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">return</span> <span class="s">&quot;NULL&quot;</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">json</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">json</span> <span class="o">=</span> <span class="n">objectMapper</span><span class="o">.</span><span class="na">writeValueAsString</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">InvalidTypeException</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="sc">&#39;\&#39;&#39;</span> <span class="o">+</span> <span class="n">json</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">&quot;\&#39;&quot;</span><span class="o">,</span> <span class="s">&quot;&#39;&#39;&quot;</span><span class="o">)</span> <span class="o">+</span> <span class="sc">&#39;\&#39;&#39;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&quot;unchecked&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">T</span> <span class="nf">parse</span><span class="o">(</span><span class="n">String</span> <span class="n">value</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InvalidTypeException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">value</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()</span> <span class="o">||</span> <span class="n">value</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;NULL&quot;</span><span class="o">))</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">value</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="o">!=</span> <span class="sc">&#39;\&#39;&#39;</span> <span class="o">||</span> <span class="n">value</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">value</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">!=</span> <span class="sc">&#39;\&#39;&#39;</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">InvalidTypeException</span><span class="o">(</span><span class="s">&quot;JSON strings must be enclosed by single quotes&quot;</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">json</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">value</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">).</span><span class="na">replace</span><span class="o">(</span><span class="s">&quot;&#39;&#39;&quot;</span><span class="o">,</span> <span class="s">&quot;&#39;&quot;</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">(</span><span class="n">T</span><span class="o">)</span> <span class="n">objectMapper</span><span class="o">.</span><span class="na">readValue</span><span class="o">(</span><span class="n">json</span><span class="o">,</span> <span class="n">toJacksonJavaType</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">InvalidTypeException</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="n">JavaType</span> <span class="nf">toJacksonJavaType</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">TypeFactory</span><span class="o">.</span><span class="na">defaultInstance</span><span class="o">().</span><span class="na">constructType</span><span class="o">(</span><span class="n">getJavaType</span><span class="o">().</span><span class="na">getType</span><span class="o">());</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<p>A few implementation guidelines:</p>
<ul class="simple">
<li><p>Your codecs should be thread-safe, or better yet, immutable;</p></li>
<li><p>Your codecs should be fast: do not forget that codecs are executed often and are usually very “hot” pieces of code;</p></li>
<li><p>Your codecs should never block.</p></li>
</ul>
<p>The second step is to register your codec with a <code class="docutils literal notranslate"><span class="pre">CodecRegistry</span></code> instance:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">JsonCodec</span><span class="o">&lt;</span><span class="n">MyPojo</span><span class="o">&gt;</span> <span class="n">myJsonCodec</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JsonCodec</span><span class="o">&lt;</span><span class="n">MyPojo</span><span class="o">&gt;(</span><span class="n">MyPojo</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">CodecRegistry</span> <span class="n">myCodecRegistry</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="na">getConfiguration</span><span class="o">().</span><span class="na">getCodecRegistry</span><span class="o">();</span>
<span class="n">myCodecRegistry</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">myJsonCodec</span><span class="o">);</span>
</pre></div>
</div>
<p>As you can see, the easiest way to do so is to access the <code class="docutils literal notranslate"><span class="pre">Cluster</span></code>’s <code class="docutils literal notranslate"><span class="pre">CodecRegistry</span></code>.
By default, <code class="docutils literal notranslate"><span class="pre">Cluster</span></code> instances will use <code class="docutils literal notranslate"><span class="pre">CodecRegistry.DEFAULT_INSTANCE</span></code>,
which should be adequate for most users.</p>
<p>It is however possible to create a <code class="docutils literal notranslate"><span class="pre">Cluster</span></code> using a different <code class="docutils literal notranslate"><span class="pre">CodecRegistry</span></code>:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">CodecRegistry</span> <span class="n">myCodecRegistry</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CodecRegistry</span><span class="o">();</span>
<span class="n">Cluster</span> <span class="n">cluster</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cluster</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">withCodecRegistry</span><span class="o">(</span><span class="n">myCodecRegistry</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
</pre></div>
</div>
<p>Note: when you instantiate a new <code class="docutils literal notranslate"><span class="pre">CodecRegistry</span></code>, it automatically registers all the default codecs used by the driver.
This ensures that the new registry will not lack of an essential codec. <em>You cannot deregister nor override
an already-registered codec, only register new ones</em>. If you try to register a codec that would override
an existing one, the driver will log a warning and ignore it.</p>
<p>From now on, your custom codec is fully operational. It will be used every time the driver encounters
a <code class="docutils literal notranslate"><span class="pre">MyPojo</span></code> instance when executing queries, or when you ask it to retrieve a <code class="docutils literal notranslate"><span class="pre">MyPojo</span></code> instance from a <code class="docutils literal notranslate"><span class="pre">ResultSet</span></code>.</p>
<p>For example, here is how to save a <code class="docutils literal notranslate"><span class="pre">MyPojo</span></code> object:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">Cluster</span> <span class="n">cluster</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">MyPojo</span> <span class="n">myPojo</span> <span class="o">=</span> <span class="o">...</span>
<span class="c1">// Using SimpleStatement</span>
<span class="n">Statement</span> <span class="n">stmt</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleStatement</span><span class="o">(</span><span class="s">&quot;INSERT INTO t (id, json) VALUES (?, ?)&quot;</span><span class="o">,</span> <span class="mi">42</span><span class="o">,</span> <span class="n">myPojo</span><span class="o">));</span>
<span class="c1">// Using the Query Builder</span>
<span class="n">BuiltStatement</span> <span class="n">insertStmt</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="o">.</span><span class="na">insertInto</span><span class="o">(</span><span class="s">&quot;t&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="na">value</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">,</span> <span class="mi">42</span><span class="o">)</span>
    <span class="o">.</span><span class="na">value</span><span class="o">(</span><span class="s">&quot;json&quot;</span><span class="o">,</span> <span class="n">myPojo</span><span class="o">);</span>
<span class="c1">// Using BoundStatements</span>
<span class="n">PreparedStatement</span> <span class="n">ps</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">prepare</span><span class="o">(</span><span class="s">&quot;INSERT INTO t (id, json) VALUES (?, ?)&quot;</span><span class="o">);</span>
<span class="n">BoundStatement</span> <span class="n">bs1</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="mi">42</span><span class="o">,</span> <span class="n">myPojo</span><span class="o">);</span> <span class="c1">// or alternatively...</span>
<span class="n">BoundStatement</span> <span class="n">bs2</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="na">bind</span><span class="o">()</span>
    <span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">42</span><span class="o">)</span>
    <span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">myPojo</span><span class="o">,</span> <span class="n">MyPojo</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</pre></div>
</div>
<p>And here is how to retrieve a <code class="docutils literal notranslate"><span class="pre">MyPojo</span></code> object converted from a JSON document:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">execute</span><span class="o">(...);</span>
<span class="n">Row</span> <span class="n">row</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">one</span><span class="o">();</span>
<span class="c1">// Let the driver convert the string for you...</span>
<span class="n">MyPojo</span> <span class="n">myPojo</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">MyPojo</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="c1">// ... or retrieve the raw string if you need it</span>
<span class="n">String</span> <span class="n">json</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span> <span class="c1">// row.getString(1) would have worked too</span>
</pre></div>
</div>
<p>Tip: <code class="docutils literal notranslate"><span class="pre">Row</span></code> and <code class="docutils literal notranslate"><span class="pre">BoundStatement</span></code> have several methods to set and retrieve values.
But if you plan to use custom codecs,
make sure that you use preferably the <code class="docutils literal notranslate"><span class="pre">get()</span></code> and <code class="docutils literal notranslate"><span class="pre">set()</span></code> methods: they
avoid any ambiguity by requiring the user to explicitly specify the desired Java type,
thus forcing the driver to pick the right codec for the right task.</p>
<p>Custom codecs also work with the driver’s <a class="reference external" href="../object_mapper/custom_codecs/">object mapper</a>.</p>
</div>
<div class="section" id="on-the-fly-codec-generation">
<h2>On-the-fly codec generation<a class="headerlink" href="#on-the-fly-codec-generation" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">CodecRegistry</span></code> instances not only store default codecs and user-defined codecs;
they can also create new codecs on the fly, based on the set of codecs they currently hold.
They can manage the following mappings:</p>
<ul class="simple">
<li><p>Collections (list, sets and maps) of known types. For example, if you registered a <code class="docutils literal notranslate"><span class="pre">TypeCodec&lt;A&gt;</span></code>, you get <code class="docutils literal notranslate"><span class="pre">List&lt;A&gt;&gt;</span></code> handled for free. This works recursively for nested collections;</p></li>
<li><p><a class="reference external" href="https://docs.datastax.com/en/drivers/java/3.10/com/datastax/driver/core/UserType.html">UserType</a> instances are automatically mapped to <a class="reference external" href="https://docs.datastax.com/en/drivers/java/3.10/com/datastax/driver/core/UDTValue.html">UDTValue</a> objects. All registered codecs are available recursively to the UDT’s fields;</p></li>
<li><p><a class="reference external" href="https://docs.datastax.com/en/drivers/java/3.10/com/datastax/driver/core/TupleType.html">TupleType</a> instances are automatically mapped to <a class="reference external" href="https://docs.datastax.com/en/drivers/java/3.10/com/datastax/driver/core/TupleValue.html">TupleValue</a> objects (with the same rules for nested fields);</p></li>
<li><p><a class="reference external" href="https://docs.datastax.com/en/drivers/java/3.10/com/datastax/driver/core/DataType.CustomType.html">CustomType</a> instances are automatically mapped to <a class="reference external" href="http://docs.oracle.com/javase/8/docs/api/java/nio/ByteBuffer.html">ByteBuffer</a> instances.</p></li>
</ul>
<p>This way, the user does not have to manually register all derived codecs for a given “base” codec.
However, other combinations of Java and CQL types not listed above cannot have their codecs created on the fly;
such codecs must be manually registered.</p>
<p>If the codec registry encounters a mapping that it can’t handle automatically, a <a class="reference external" href="https://docs.datastax.com/en/drivers/java/3.10/com/datastax/driver/core/exceptions/CodecNotFoundException.html">CodecNotFoundException</a>
is thrown.</p>
<p>Thanks to on-the-fly codec generation, it is possible to leverage the <code class="docutils literal notranslate"><span class="pre">JsonCodec</span></code> from our previous
example to retrieve lists of <code class="docutils literal notranslate"><span class="pre">MyPojo</span></code> objects stored in a CQL column of type <code class="docutils literal notranslate"><span class="pre">list&lt;text&gt;</span></code>, without
the need to explicitly declare a codec for this specific CQL type:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">JsonCodec</span><span class="o">&lt;</span><span class="n">MyPojo</span><span class="o">&gt;</span> <span class="n">myJsonCodec</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JsonCodec</span><span class="o">&lt;</span><span class="n">MyPojo</span><span class="o">&gt;(</span><span class="n">MyPojo</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">myCodecRegistry</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">myJsonCodec</span><span class="o">);</span>
<span class="n">Row</span> <span class="n">row</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">MyPojo</span><span class="o">&gt;</span> <span class="n">myPojos</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="na">getList</span><span class="o">(</span><span class="s">&quot;jsonList&quot;</span><span class="o">,</span> <span class="n">MyPojo</span><span class="o">.</span><span class="na">class</span><span class="o">);</span> <span class="c1">// works out of the box!</span>
</pre></div>
</div>
</div>
<div class="section" id="creating-custom-codecs-for-user-defined-types-udts">
<h2>Creating custom codecs for user-defined types (UDTs)<a class="headerlink" href="#creating-custom-codecs-for-user-defined-types-udts" title="Permalink to this headline">¶</a></h2>
<p>By default, the driver maps user-defined type values to <a class="reference external" href="https://docs.datastax.com/en/drivers/java/3.10/com/datastax/driver/core/UDTValue.html">UDTValue</a> instances.</p>
<p>If you want to register a custom codec for a specific user-defined type,
follow these steps:</p>
<p>Let’s suppose you have a keyspace containing the following type and table:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TYPE</span> <span class="n">address</span> <span class="p">(</span><span class="n">street</span> <span class="nb">VARCHAR</span><span class="p">,</span> <span class="n">zipcode</span> <span class="nb">INT</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">users</span> <span class="p">(</span><span class="n">id</span> <span class="n">UUID</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span> <span class="n">name</span> <span class="nb">VARCHAR</span><span class="p">,</span> <span class="n">address</span> <span class="n">frozen</span><span class="o">&lt;</span><span class="n">address</span><span class="o">&gt;</span><span class="p">);</span>
</pre></div>
</div>
<p>And let’s suppose that you want to map the type <code class="docutils literal notranslate"><span class="pre">address</span></code> to an <code class="docutils literal notranslate"><span class="pre">Address</span></code> class:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Address</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">street</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">zipcode</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Address</span><span class="o">(</span><span class="n">String</span> <span class="n">street</span><span class="o">,</span> <span class="kt">int</span> <span class="n">zipcode</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">street</span> <span class="o">=</span> <span class="n">street</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">zipcode</span> <span class="o">=</span> <span class="n">zipcode</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// getters, setters, equals() and hashcode() omitted</span>
<span class="o">}</span>
</pre></div>
</div>
<p>First of all, create a codec that knows how to serialize this class; one possible solution
(but not necessarily the most efficient one) would be to convert <code class="docutils literal notranslate"><span class="pre">Address</span></code> instances into <code class="docutils literal notranslate"><span class="pre">UDTValue</span></code>
instances, then serialize them with another codec:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AddressCodec</span> <span class="kd">extends</span> <span class="n">TypeCodec</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">TypeCodec</span><span class="o">&lt;</span><span class="n">UDTValue</span><span class="o">&gt;</span> <span class="n">innerCodec</span><span class="o">;</span>
    
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">UserType</span> <span class="n">userType</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">AddressCodec</span><span class="o">(</span><span class="n">TypeCodec</span><span class="o">&lt;</span><span class="n">UDTValue</span><span class="o">&gt;</span> <span class="n">innerCodec</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;</span> <span class="n">javaType</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">innerCodec</span><span class="o">.</span><span class="na">getCqlType</span><span class="o">(),</span> <span class="n">javaType</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">innerCodec</span> <span class="o">=</span> <span class="n">innerCodec</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">userType</span> <span class="o">=</span> <span class="o">(</span><span class="n">UserType</span><span class="o">)</span><span class="n">innerCodec</span><span class="o">.</span><span class="na">getCqlType</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">ByteBuffer</span> <span class="nf">serialize</span><span class="o">(</span><span class="n">Address</span> <span class="n">value</span><span class="o">,</span> <span class="n">ProtocolVersion</span> <span class="n">protocolVersion</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InvalidTypeException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">innerCodec</span><span class="o">.</span><span class="na">serialize</span><span class="o">(</span><span class="n">toUDTValue</span><span class="o">(</span><span class="n">value</span><span class="o">),</span> <span class="n">protocolVersion</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Address</span> <span class="nf">deserialize</span><span class="o">(</span><span class="n">ByteBuffer</span> <span class="n">bytes</span><span class="o">,</span> <span class="n">ProtocolVersion</span> <span class="n">protocolVersion</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InvalidTypeException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">toAddress</span><span class="o">(</span><span class="n">innerCodec</span><span class="o">.</span><span class="na">deserialize</span><span class="o">(</span><span class="n">bytes</span><span class="o">,</span> <span class="n">protocolVersion</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Address</span> <span class="nf">parse</span><span class="o">(</span><span class="n">String</span> <span class="n">value</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InvalidTypeException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">value</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">value</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()</span> <span class="o">||</span> <span class="n">value</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;NULL&quot;</span><span class="o">)</span> <span class="o">?</span> 
            <span class="kc">null</span> <span class="o">:</span> <span class="n">toAddress</span><span class="o">(</span><span class="n">innerCodec</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">format</span><span class="o">(</span><span class="n">Address</span> <span class="n">value</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InvalidTypeException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">value</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="s">&quot;NULL&quot;</span> <span class="o">:</span> <span class="n">innerCodec</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">toUDTValue</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="n">Address</span> <span class="nf">toAddress</span><span class="o">(</span><span class="n">UDTValue</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">value</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="k">new</span> <span class="n">Address</span><span class="o">(</span>
            <span class="n">value</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;street&quot;</span><span class="o">),</span> 
            <span class="n">value</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&quot;zipcode&quot;</span><span class="o">)</span>
        <span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="n">UDTValue</span> <span class="nf">toUDTValue</span><span class="o">(</span><span class="n">Address</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">value</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">userType</span><span class="o">.</span><span class="na">newValue</span><span class="o">()</span>
            <span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="s">&quot;street&quot;</span><span class="o">,</span> <span class="n">value</span><span class="o">.</span><span class="na">getStreet</span><span class="o">())</span>
            <span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="s">&quot;zipcode&quot;</span><span class="o">,</span> <span class="n">value</span><span class="o">.</span><span class="na">getZipcode</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Now (and only if you intend to use your own <code class="docutils literal notranslate"><span class="pre">CodecRegistry</span></code>),
create it and register it on your <code class="docutils literal notranslate"><span class="pre">Cluster</span></code> instance:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// only if you do not intend to use CodecRegistry.DEFAULT_INSTANCE</span>
<span class="n">CodecRegistry</span> <span class="n">codecRegistry</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CodecRegistry</span><span class="o">();</span>
<span class="n">Cluster</span> <span class="n">cluster</span> <span class="o">=</span> <span class="n">Cluster</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
    <span class="o">.</span><span class="na">addContactPoints</span><span class="o">(...)</span>
    <span class="o">.</span><span class="na">withCodecRegistry</span><span class="o">(</span><span class="n">codecRegistry</span><span class="o">)</span>
    <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</pre></div>
</div>
<p>Now, retrieve the metadata for type <code class="docutils literal notranslate"><span class="pre">address</span></code>:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">UserType</span> <span class="n">addressType</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">().</span><span class="na">getKeyspace</span><span class="o">(...).</span><span class="na">getUserType</span><span class="o">(</span><span class="s">&quot;address&quot;</span><span class="o">);</span>
<span class="n">TypeCodec</span><span class="o">&lt;</span><span class="n">UDTValue</span><span class="o">&gt;</span> <span class="n">addressTypeCodec</span> <span class="o">=</span> <span class="n">codecRegistry</span><span class="o">.</span><span class="na">codecFor</span><span class="o">(</span><span class="n">addressType</span><span class="o">);</span>
</pre></div>
</div>
<p>And finally, register your <code class="docutils literal notranslate"><span class="pre">AddressCodec</span></code> with the <code class="docutils literal notranslate"><span class="pre">CodecRegistry</span></code>. Note that
your codec simply delegates the hard work to an inner codec that knows how to deal with
user type values:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">AddressCodec</span> <span class="n">addressCodec</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AddressCodec</span><span class="o">(</span><span class="n">addressTypeCodec</span><span class="o">,</span> <span class="n">Address</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">codecRegistry</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">addressCodec</span><span class="o">);</span>
</pre></div>
</div>
<p>And voilà! You can now retrieve <code class="docutils literal notranslate"><span class="pre">address</span></code> values as <code class="docutils literal notranslate"><span class="pre">Address</span></code> instances:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">ResultSet</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">execute</span><span class="o">(...);</span>
<span class="n">Row</span> <span class="n">row</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="na">one</span><span class="o">();</span>
<span class="c1">// let the driver convert it for you...</span>
<span class="n">Address</span> <span class="n">address</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;address&quot;</span><span class="o">,</span> <span class="n">Address</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="c1">// ...or access the low-level UDTValue, if you need</span>
<span class="n">UDTValue</span> <span class="n">addressUdt</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;address&quot;</span><span class="o">,</span> <span class="n">UDTValue</span><span class="o">.</span><span class="na">class</span><span class="o">);</span> <span class="c1">// row.getUDTValue(&quot;address&quot;) would have worked too</span>
</pre></div>
</div>
<p>Note that this solution creates an intermediary <code class="docutils literal notranslate"><span class="pre">UDTValue</span></code> object when
serializing and deserializing. It’s possible to bypass this step with a
lower-level implementation that manipulates the binary stream directly.
That’s also how the object mapper handles UDTs, and you can rely on the
mapper to generate UDT codecs for you; see
<a class="reference external" href="../object_mapper/custom_codecs/#implicit-udt-codecs">this page</a> for more
information.</p>
</div>
<div class="section" id="support-for-generic-parameterized-types">
<h2>Support for generic (parameterized) types<a class="headerlink" href="#support-for-generic-parameterized-types" title="Permalink to this headline">¶</a></h2>
<p>Java generic (parameterized) types are fully supported, through Guava’s <a class="reference external" href="https://google.github.io/guava/releases/19.0/api/docs/com/google/common/reflect/TypeToken.html">TypeToken</a> API.
Be sure to only use <code class="docutils literal notranslate"><span class="pre">get()</span></code> and <code class="docutils literal notranslate"><span class="pre">set()</span></code> methods that take a <code class="docutils literal notranslate"><span class="pre">TypeToken</span></code> argument:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// this works</span>
<span class="n">Foo</span><span class="o">&lt;</span><span class="n">Bar</span><span class="o">&gt;</span> <span class="n">foo</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="k">new</span> <span class="n">TypeToken</span><span class="o">&lt;</span><span class="n">Foo</span><span class="o">&lt;</span><span class="n">Bar</span><span class="o">&gt;&gt;(){})</span>
<span class="c1">// this does not work due to type erasure</span>
<span class="n">Foo</span><span class="o">&lt;</span><span class="n">Bar</span><span class="o">&gt;</span> <span class="n">foo</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">Foo</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</pre></div>
</div>
</div>
<div class="section" id="support-for-subtype-polymorphism">
<h2>Support for subtype polymorphism<a class="headerlink" href="#support-for-subtype-polymorphism" title="Permalink to this headline">¶</a></h2>
<p>Suppose the following class hierarchy:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">Animal</span> <span class="o">{}</span>
<span class="kd">class</span> <span class="nc">Cat</span> <span class="kd">extends</span> <span class="n">Animal</span> <span class="o">{}</span>
</pre></div>
</div>
<p>By default, a codec will accept to serialize any object that extends or
implements its declared Java type: a codec such as
<code class="docutils literal notranslate"><span class="pre">AnimalCodec</span> <span class="pre">extends</span> <span class="pre">TypeCodec&lt;Animal&gt;</span></code> will accept <code class="docutils literal notranslate"><span class="pre">Cat</span></code> instances as well.</p>
<p>This allows a codec to handle interfaces and superclasses
in a generic way, regardless of the actual implementation being
used by client code; for example, the driver has a built-in codec
that handles <code class="docutils literal notranslate"><span class="pre">List</span></code> instances, and this codec is capable of
serializing any concrete <code class="docutils literal notranslate"><span class="pre">List</span></code> implementation.</p>
<p>But this has one caveat: when setting or retrieving values
with <code class="docutils literal notranslate"><span class="pre">get()</span></code> and <code class="docutils literal notranslate"><span class="pre">set()</span></code>, <em>it is vital to pass the exact
Java type the codec handles</em>:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">codecRegistry</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="k">new</span> <span class="n">AnimalCodec</span><span class="o">());</span>
<span class="n">BoundStatement</span> <span class="n">bs</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">bs</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="k">new</span> <span class="n">Cat</span><span class="o">(),</span> <span class="n">Animal</span><span class="o">.</span><span class="na">class</span><span class="o">);</span> <span class="c1">// works</span>
<span class="n">bs</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="k">new</span> <span class="n">Cat</span><span class="o">(),</span>    <span class="n">Cat</span><span class="o">.</span><span class="na">class</span><span class="o">);</span> <span class="c1">// throws CodecNotFoundException</span>
</pre></div>
</div>
<p>The same is valid when retrieving values:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">codecRegistry</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="k">new</span> <span class="n">AnimalCodec</span><span class="o">());</span>
<span class="n">Row</span> <span class="n">row</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">Animal</span> <span class="n">animal</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">Animal</span><span class="o">.</span><span class="na">class</span><span class="o">);</span> <span class="c1">// works</span>
<span class="n">Cat</span>    <span class="n">cat</span>    <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span>    <span class="n">Cat</span><span class="o">.</span><span class="na">class</span><span class="o">);</span> <span class="c1">// throws CodecNotFoundException</span>
</pre></div>
</div>
</div>
<div class="section" id="performance-considerations">
<h2>Performance considerations<a class="headerlink" href="#performance-considerations" title="Permalink to this headline">¶</a></h2>
<p>A codec lookup operation may be costly; to mitigate this, the <code class="docutils literal notranslate"><span class="pre">CodecRegistry</span></code>
caches lookup results whenever possible.</p>
<p>When the cache can be used and the registry looks up a codec, the following rules apply:</p>
<ol class="simple">
<li><p>if a result was previously cached for that mapping, it is returned;</p></li>
<li><p>otherwise, the registry checks the list of “basic” codecs: the default ones,
and the ones that were explicitly registered (in the order that they were registered).
It calls each codec’s <a class="reference external" href="https://docs.datastax.com/en/drivers/java/3.10/com/datastax/driver/core/TypeCodec.html#accepts-com.datastax.driver.core.DataType-">accepts</a> methods to determine if it can handle the mapping,
and if so, adds it to the cache and returns it;</p></li>
<li><p>otherwise, the registry tries to generate a codec on the fly, according to the rules outlined above;</p></li>
<li><p>if the creation succeeds, the registry adds the created codec to the cache and returns it;</p></li>
<li><p>otherwise, the registry throws <a class="reference external" href="https://docs.datastax.com/en/drivers/java/3.10/com/datastax/driver/core/exceptions/CodecNotFoundException.html">CodecNotFoundException</a>.</p></li>
</ol>
<p>The cache can be used as long as <em>at least the CQL type is known</em>. The following situations
are exceptions where it is <em>not</em> possible to cache lookup results:</p>
<ul class="simple">
<li><p>With <a class="reference external" href="https://docs.datastax.com/en/drivers/java/3.10/com/datastax/driver/core/SimpleStatement.html">SimpleStatement</a> instances;</p></li>
<li><p>With <a class="reference external" href="https://docs.datastax.com/en/drivers/java/3.10/com/datastax/driver/core/querybuilder/BuiltStatement.html">BuiltStatement</a> instances (created via the Query Builder).</p></li>
</ul>
<p>In these places, the driver has no way to determine the right CQL type to use, so it performs
a best-effort heuristic to guess which codec to use. The result of this heuristic is never cached.</p>
<p>Beware that in these cases, the lookup performs in average 10x worse. If performance is a key factor for your application,
consider using prepared statements all the time.</p>
</div>
</div>

        </div>

        <div id="sidebar" class="large-3 large-pull-6 columns"><div class="side-nav">
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../README.html">Manual</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../address_resolution/README.html">Address resolution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../async/README.html">Asynchronous programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="../auth/README.html">Authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cloud/README.html">Connecting to Apollo (Cloud)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../compression/README.html">Compression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../control_connection/README.html">Control connection</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Custom Codecs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../custom_payloads/README.html">Custom Payloads</a></li>
<li class="toctree-l2"><a class="reference internal" href="../idempotence/README.html">Query idempotence</a></li>
<li class="toctree-l2"><a class="reference internal" href="../load_balancing/README.html">Load balancing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging/README.html">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metadata/README.html">Metadata</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metrics/README.html">Metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../native_protocol/README.html">Native protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="../object_mapper/README.html">Object Mapper</a></li>
<li class="toctree-l2"><a class="reference internal" href="../osgi/README.html">OSGi</a></li>
<li class="toctree-l2"><a class="reference internal" href="../paging/README.html">Paging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pooling/README.html">Connection pooling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../query_timestamps/README.html">Query timestamps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reconnection/README.html">Reconnection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../retries/README.html">Retries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shaded_jar/README.html">Using the shaded JAR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../socket_options/README.html">Socket options</a></li>
<li class="toctree-l2"><a class="reference internal" href="../speculative_execution/README.html">Speculative query execution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ssl/README.html">SSL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../statements/README.html">Statements</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tuples/README.html">Using Tuples with the Java driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../udts/README.html">User-defined types</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../upgrade_guide/README.html">Upgrade guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/README.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog/README.html">Changelog</a></li>
</ul>

</div>
        </div>

        <div class="large-3 columns">
            
        </div>

    </div>
</section>

<!-- newsleter modal -->

<div id="newsletter_signup" class="reveal-modal tiny radius dark_modal" data-reveal aria-labelledby="modalTitle" aria-hidden="true" role="dialog">
    <a class="close-reveal-modal" aria-label="Close">×</a>
    <h2 id="modalTitle">Sign up for the Scylla newsletter</h2>
    <div id="mc_embed_signup">
        <form action="//cloudius-systems.us10.list-manage.com/subscribe/post?u=df8bb543c68230d5f7b4dcf78&amp;id=9a4589f144" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate="">
            <div id="mc_embed_signup_scroll">

                <div class="mc-field-group">
                    <div class="row collapse">
                        <div class="small-3 columns"><label for="mce-EMAIL">Email</label></div>
                        <div class="small-9 columns"><input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL"></div>
                    </div>
                </div>
                <div class="mc-field-group">
                    <div class="row collapse">
                        <div class="small-3 columns"><label for="mce-FNAME">First Name </label></div>
                        <div class="small-9 columns"><input type="text" value="" name="FNAME" class="" id="mce-FNAME"></div>
                    </div>
                </div>
                <div class="mc-field-group">
                    <div class="row collapse">
                        <div class="small-3 columns"><label for="mce-LNAME">Last Name </label></div>
                        <div class="small-9 columns"><input type="text" value="" name="LNAME" class="" id="mce-LNAME"></div>
                    </div>
                </div>
                <div id="mce-responses" class="clear">
                    <div class="response" id="mce-error-response" style="display:none"></div>
                    <div class="response" id="mce-success-response" style="display:none"></div>
                </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
                <div style="position: absolute; left: -5000px;"><input type="text" name="b_df8bb543c68230d5f7b4dcf78_9a4589f144" tabindex="-1" value=""></div>
                <div class="clear"><input type="submit" class="button" value="Sign up" name="subscribe" id="mc-embedded-subscribe"></div>
            </div>
        </form>
    </div>
</div>

<!-- end newsleter modal -->



<!-- footer.html -->
<footer id="footer">
    <div class="footer-top">
        <a class="logo" href="https://www.scylladb.com"><img src="../../_static/img/logo-scylla-horizontal-RGB.svg" alt=""></a>
        <div class="footer-links">
            <a class="link" href="https://docs.scylladb.com">Docs</a>
            <a class="link" href="https://www.scylladb.com/company/contact-us/">Contact Us</a>
            <a class="link" href="https://www.scylladb.com/company/">About Us</a>
            <a class="link button" href="https://github.com/scylladb/java-driver/issues/new?title=Issue in page Custom Codecs&&body=I%20would%20like%20to%20report%20an%20issue%20in%20page%20http://docs.scylladb.com/manual/custom_codecs/README%0A%0A%23%23%23%20Problem%0A%0A%23%23%23%20%20Suggest%20a%20fix" target="_blank">
                Report an issue on this page</a>
        </div>
        <div class="footer-actions">
            <a class="link-icon" href="https://github.com/ScyllaDB" target="_blank">
                <span class="icon-github2"></span></a>
            <a class="link-icon" href="https://twitter.com/ScyllaDB" target="_blank">
                <span class="icon-twitter"></span></a>
            <a class="link-icon" href="https://www.linkedin.com/company/scylladb"  target="_blank">
                <span class="icon-linkedin2"></span></a>
            <a class="link-icon" href="https://www.facebook.com/scylladb/" target="_blank">
                <span class="icon-facebook"></span></a>
        </div>
    </div>

    <div class="footer-bottom">
        <div class="footer-info">
            <div class="footer-copyright">
                &#169; 2012, ScyllaDB. All rights reserved.
            </div>
            <div class="footer-last-updated">
                Last updated on 20 October 2020.
            </div>
        </div>
        <div class="footer-links">
        </div>
    </div>
</footer>
<!-- end footer.html -->

<!-- bodyscripts.html -->
<!-- at the end of the BODY --> 
<script src="../../_static/js/vendor/jquery.js"></script>
<script src="../../_static/expertrec.js"></script>
<script src="../../_static/js/foundation/foundation.js"></script>
<script src="../../_static/js/foundation/foundation.topbar.js"></script>
<script src="../../_static/app.js"></script>
<script>
    $(document).foundation();
</script>
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T8P2JP"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->

  <!-- end bodyscripts.html -->
</body>
</html>